---
# =============================================================================
# Authentication Service - Deployment
# =============================================================================
# Handles user authentication, OTP, JWT tokens, and user registration.
#
# Dependencies:
# - PostgreSQL (auth_oltp schema)
# - Redis (OTP, sessions, blacklist)
# - Kafka (event publishing)
#
# Environment Variables:
# - Database connection via postgres-connection secret
# - Redis connection via redis-connection secret
# - Kafka bootstrap servers from configmap
# - JWT secrets from jwt-secrets
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: authentication-service
  namespace: orange-wallet
  labels:
    app: authentication-service
    component: backend
    tier: application
    version: v1
spec:
  replicas: 1  # HPA will scale to max 2 based on load
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: authentication-service
      component: backend

  template:
    metadata:
      labels:
        app: authentication-service
        component: backend
        tier: application
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/actuator/prometheus"

    spec:
      # Run on stateless worker nodes
      nodeSelector:
        workload-type: stateless

      # Pod security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      containers:
        - name: authentication-service
          image: teukumunawar/orange-wallet-authentication-service:latest
          imagePullPolicy: Always

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP

          env:
            # Application
            - name: SERVER_PORT
              value: "8080"

            - name: SPRING_APPLICATION_NAME
              value: "authentication-service"

            - name: SPRING_PROFILES_ACTIVE
              value: "prod"

            # Spring Cloud Config
            - name: SPRING_CONFIG_IMPORT
              value: "configserver:http://cloud-config-server.orange-wallet.svc.cluster.local:8888"

            # Database Connection
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  name: postgres-connection
                  key: jdbc-url

            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-connection
                  key: username

            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-connection
                  key: password

            # Spring Datasource (explicit for Spring Boot property injection)
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-connection
                  key: username

            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-connection
                  key: password

            # Flyway Schema
            - name: SPRING_FLYWAY_SCHEMAS
              value: "auth_oltp"

            - name: SPRING_FLYWAY_DEFAULT_SCHEMA
              value: "auth_oltp"

            # Redis Connection
            - name: REDIS_HOST
              valueFrom:
                secretKeyRef:
                  name: redis-connection
                  key: host

            - name: REDIS_PORT
              valueFrom:
                secretKeyRef:
                  name: redis-connection
                  key: port

            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-connection
                  key: password

            # Kafka (bootstrap config - keep for initial connection)
            - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: kafka-config
                  key: bootstrap-servers

            # JWT, reCAPTCHA configs removed - now managed via Spring Cloud Config
            # See: spring-cloud-configmap/authentication-service.yml

            # RSA Keys (infrastructure-specific paths - managed via ENV vars)
            # Keys mounted from Secret to /app/keys/
            # Spring Boot relaxed binding: ORANGE_RSA_PUBLICKEY â†’ orange.rsa.publickey
            # But we need orange.rsa.public-key, so use ORANGE_RSA_PUBLIC-KEY (not possible)
            # Solution: Use direct property override with Spring syntax
            - name: ORANGE.RSA.PUBLIC-KEY
              value: "file:/app/keys/public.pem"

            - name: ORANGE.RSA.PRIVATE-KEY
              value: "file:/app/keys/private.pem"

            # Google reCAPTCHA secret (sensitive - keep in Secret)
            - name: GOOGLE_RECAPTCHA_SECRET
              valueFrom:
                secretKeyRef:
                  name: external-api-keys
                  key: recaptcha-secret
                  optional: true

            # JVM Options
            - name: JAVA_OPTS
              value: >-
                -XX:+UseContainerSupport
                -XX:MaxRAMPercentage=75.0
                -XX:InitialRAMPercentage=50.0
                -XX:+UseG1GC
                -XX:MaxGCPauseMillis=200
                -XX:+HeapDumpOnOutOfMemoryError
                -XX:HeapDumpPath=/tmp/heapdump.hprof
                -Duser.timezone=Asia/Jakarta

          # Resource allocation
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi

          # Health checks
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          startupProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 12

          # Volume mounts
          volumeMounts:
            - name: rsa-keys
              mountPath: /app/keys
              readOnly: true

            - name: tmp
              mountPath: /tmp

      # Volumes
      volumes:
        - name: rsa-keys
          secret:
            secretName: authentication-rsa-keys
            defaultMode: 0400  # Read-only for owner (security best practice)

        - name: tmp
          emptyDir: {}

      # Restart policy
      restartPolicy: Always

      # Termination grace period
      terminationGracePeriodSeconds: 30
