---
# =============================================================================
# ML Engine - Deployment
# =============================================================================
# Python FastAPI service for AI-powered split bill feature using Google Gemini
#
# Dependencies:
# - MongoDB (split bill data storage)
# - Kafka (event streaming)
# - Authentication Service (JWT validation)
# - Google Cloud (Gemini AI API)
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-engine
  namespace: orange-wallet
  labels:
    app: ml-engine
    component: ml
    tier: application
    version: v1
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: ml-engine
      component: ml

  template:
    metadata:
      labels:
        app: ml-engine
        component: ml
        tier: application
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"

    spec:
      nodeSelector:
        workload-type: stateless

      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001

      containers:
        - name: ml-engine
          image: teukumunawar/orange-wallet-ml-engine:latest
          imagePullPolicy: Always

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP

          env:
            # Application Configuration
            - name: PORT
              value: "8080"

            - name: LOG_LEVEL
              value: "INFO"

            # MongoDB Connection
            - name: MONGO_URI
              valueFrom:
                secretKeyRef:
                  name: mongodb-connection
                  key: uri

            - name: MONGO_DB_NAME
              value: "split_bill_db"

            # Kafka
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: kafka-config
                  key: bootstrap-servers

            # JWT/Auth Configuration
            - name: JWK_SET_URI
              value: "http://authentication-service.orange-wallet.svc.cluster.local:8080/oauth2/jwks"

            - name: JWT_ISSUER
              value: "auth-service"

            - name: JWT_CACHE_TTL_SEC
              value: "300"

            # Google AI Configuration
            - name: GOOGLE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: external-api-keys
                  key: google-api-key

            - name: GEMINI_MODEL
              value: "models/gemini-2.0-flash-exp"

            # Short Link Configuration
            - name: SHORTLINK_SECRET
              valueFrom:
                secretKeyRef:
                  name: app-config-secrets
                  key: shortlink-secret

            - name: SHORTLINK_TTL_MIN
              value: "4320"

            - name: APP_BASE_URL
              value: "https://orange-wallet.example.com"

            # Wallet Webhook Secret
            - name: WALLET_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: app-config-secrets
                  key: wallet-webhook-secret

          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi

          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 12

      restartPolicy: Always
      terminationGracePeriodSeconds: 30
