---
# =============================================================================
# Ingress - Orange Wallet API Gateway
# =============================================================================
# Routes external HTTP/HTTPS traffic to the API Gateway service.
#
# Architecture:
#   Internet → Cloudflare (TLS) → GCP LB → NGINX Ingress → API Gateway
#
# TLS:
#   - Cloudflare Origin Certificate (15-year validity)
#   - Cloudflare SSL Mode: Full (strict)
#   - End-to-end encryption
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: orange-wallet-ingress
  namespace: orange-wallet
  labels:
    app.kubernetes.io/name: orange-wallet-ingress
    app.kubernetes.io/part-of: orange-wallet
  annotations:
    # NGINX Ingress
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Timeouts (increased for long-running operations and streaming connections)
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"

    # Request size
    nginx.ingress.kubernetes.io/proxy-body-size: "5m"

    # HTTP/2
    nginx.ingress.kubernetes.io/http2-push-preload: "true"

    # HSTS
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"
    nginx.ingress.kubernetes.io/hsts-preload: "true"

    # CORS (API Gateway handles this, but adding defense-in-depth)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://orangebybni.my.id, https://www.orangebybni.my.id, https://app.orangebybni.my.id"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

spec:
  ingressClassName: nginx

  tls:
    - hosts:
        - api.orangebybni.my.id
        - orangebybni.my.id
        - www.orangebybni.my.id
      secretName: cloudflare-origin-tls

  rules:
    - host: api.orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

    - host: orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

    - host: www.orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

---
# =============================================================================
# Ingress - Direct Backend Access (Development Only)
# =============================================================================
# For development and debugging, allows direct access to backend services.
# REMOVE THIS IN PRODUCTION - all traffic should go through API Gateway.
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: orange-wallet-backend-dev
  namespace: orange-wallet
  labels:
    app.kubernetes.io/name: orange-wallet-backend-dev
    app.kubernetes.io/part-of: orange-wallet
    environment: dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

spec:
  ingressClassName: nginx

  rules:
    - http:
        paths:
          # Authentication Service
          - path: /auth(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: authentication-service
                port:
                  number: 8080

          # User Service
          - path: /users(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: user-service
                port:
                  number: 8080

          # Wallet Service
          - path: /wallets(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: wallet-service
                port:
                  number: 8080

          # Transaction Service
          - path: /transactions(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: transaction-service
                port:
                  number: 8080
