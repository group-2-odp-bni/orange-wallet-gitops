---
# =============================================================================
# Ingress - Orange Wallet API Gateway
# =============================================================================
# Routes external HTTP/HTTPS traffic to the API Gateway service.
#
# Architecture:
#   Internet → NGINX Ingress Controller → API Gateway → Backend Services
#
# Access:
#   - Production: https://api.orangebybni.my.id
#   - Dev: http://<MASTER_IP>:30080
#
# TLS:
#   - Certificate managed by Cert-Manager
#   - Let's Encrypt for production
#   - Self-signed for development
#
# CORS:
#   - Configured at API Gateway level (Spring Cloud Gateway)
#   - Ingress passes through all headers
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: orange-wallet-ingress
  namespace: orange-wallet
  labels:
    app.kubernetes.io/name: orange-wallet-ingress
    app.kubernetes.io/part-of: orange-wallet
  annotations:
    # NGINX Ingress specific annotations
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"  # Redirect HTTP to HTTPS

    # Force HTTPS (additional security)
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Connection settings
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "90"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "90"

    # Request size limits
    nginx.ingress.kubernetes.io/proxy-body-size: "5m"

    # Enable HTTP/2
    nginx.ingress.kubernetes.io/http2-push-preload: "true"

    # HSTS (HTTP Strict Transport Security) for production
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"  # 1 year
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"
    nginx.ingress.kubernetes.io/hsts-preload: "true"

    # CORS (additional layer, API Gateway also handles CORS)
    # Restricted to specific origins for production security
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://orangebybni.my.id, https://www.orangebybni.my.id, https://app.orangebybni.my.id, https://orangebybni.my.id, https://api.orangebybni.my.id, https://app.orangebybni.my.id"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # Rate limiting (production security)
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-rpm: "1000"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # Cert-Manager annotations (for automatic TLS certificate)
    cert-manager.io/cluster-issuer: "letsencrypt-staging"  # Switch to 'letsencrypt-prod' after testing
    cert-manager.io/acme-challenge-type: "http01"

spec:
  ingressClassName: nginx

  # TLS configuration
  tls:
    - hosts:
        - api.orangebybni.my.id
        - orangebybni.my.id
        - www.orangebybni.my.id
      secretName: orange-wallet-tls-secret  # Managed by Cert-Manager
    - hosts:
        - api.orangebybni.my.id
        - orangebybni.my.id
      secretName: orangebybni-tls-secret  # Managed by Cert-Manager

  rules:
    # Production rule with domain (TLS-enabled)
    - host: api.orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

    # Redirect root domain to API subdomain
    - host: orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

    # WWW subdomain (redirects to api.orangebybni.my.id)
    - host: www.orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

    # orangebybni.my.id domain rules
    - host: api.orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

    - host: orangebybni.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

    # Fallback rule for IP-based access (development/testing)
    # Note: TLS will show certificate error when accessing via IP
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

---
# =============================================================================
# Ingress - Direct Backend Access (Development Only)
# =============================================================================
# For development and debugging, allows direct access to backend services.
# REMOVE THIS IN PRODUCTION - all traffic should go through API Gateway.
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: orange-wallet-backend-dev
  namespace: orange-wallet
  labels:
    app.kubernetes.io/name: orange-wallet-backend-dev
    app.kubernetes.io/part-of: orange-wallet
    environment: dev
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "false"

spec:
  ingressClassName: nginx

  rules:
    - http:
        paths:
          # Authentication Service
          - path: /auth(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: authentication-service
                port:
                  number: 8080

          # User Service
          - path: /users(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: user-service
                port:
                  number: 8080

          # Wallet Service
          - path: /wallets(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: wallet-service
                port:
                  number: 8080

          # Transaction Service
          - path: /transactions(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: transaction-service
                port:
                  number: 8080
