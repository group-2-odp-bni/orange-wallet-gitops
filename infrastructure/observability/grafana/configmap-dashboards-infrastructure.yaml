---
# =============================================================================
# Grafana - Infrastructure & Tracing Dashboards
# =============================================================================
# Advanced dashboards for:
# - Distributed Tracing Explorer
# - Infrastructure & K8s Monitoring
# - Security & Audit
# - SLO/SLI Tracking
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-infrastructure
  namespace: observability
  labels:
    app: grafana
    component: visualization
    grafana_dashboard: "1"
data:
  # ===========================================================================
  # Dashboard 4: Distributed Tracing Explorer
  # ===========================================================================
  tracing-explorer.json: |
    {
      "title": "Distributed Tracing Explorer",
      "uid": "tracing-orange-wallet",
      "tags": ["tracing", "tempo", "service-mesh"],
      "timezone": "browser",
      "refresh": "1m",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "panels": [
        {
          "id": 1,
          "type": "row",
          "title": "Service Dependencies",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
          "collapsed": false
        },
        {
          "id": 2,
          "type": "nodeGraph",
          "title": "Service Dependency Graph",
          "datasource": {"type": "tempo", "uid": "tempo"},
          "gridPos": {"h": 12, "w": 24, "x": 0, "y": 1},
          "targets": [
            {
              "queryType": "serviceMap",
              "refId": "A"
            }
          ],
          "options": {
            "nodes": {
              "mainStatUnit": "ms",
              "secondaryStatUnit": "reqps",
              "arcs": [
                {
                  "field": "success_rate",
                  "color": "green",
                  "scale": {
                    "min": 0.9,
                    "max": 1
                  }
                },
                {
                  "field": "error_rate",
                  "color": "red",
                  "scale": {
                    "min": 0,
                    "max": 0.1
                  }
                }
              ]
            }
          }
        },
        {
          "id": 3,
          "type": "row",
          "title": "Trace Analytics",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 13},
          "collapsed": false
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Total Traces (1h)",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 14},
          "targets": [
            {
              "expr": "sum(increase(tempo_distributor_spans_received_total[1h]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "unit": "short",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area"
          }
        },
        {
          "id": 5,
          "type": "stat",
          "title": "Avg Trace Duration",
          "datasource": {"type": "tempo", "uid": "tempo"},
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 14},
          "targets": [
            {
              "queryType": "metrics",
              "query": "avg(duration)",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "unit": "ms",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 500},
                  {"color": "red", "value": 1000}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none"
          }
        },
        {
          "id": 6,
          "type": "stat",
          "title": "Spans with Errors",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 14},
          "targets": [
            {
              "expr": "sum(increase(tempo_distributor_spans_received_total{status=\"error\"}[1h]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "unit": "short",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 100},
                  {"color": "red", "value": 500}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area"
          }
        },
        {
          "id": 7,
          "type": "stat",
          "title": "Services Traced",
          "datasource": {"type": "tempo", "uid": "tempo"},
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 14},
          "targets": [
            {
              "queryType": "metrics",
              "query": "count(distinct(service.name))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "unit": "short",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "purple", "value": null}
                ]
              }
            }
          },
          "options": {
            "colorMode": "value",
            "graphMode": "none"
          }
        },
        {
          "id": 10,
          "type": "timeseries",
          "title": "Trace Duration Heatmap",
          "datasource": {"type": "tempo", "uid": "tempo"},
          "gridPos": {"h": 10, "w": 24, "x": 0, "y": 18},
          "targets": [
            {
              "queryType": "traceql",
              "query": "{ duration > 0 }",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "spectrum"},
              "custom": {
                "drawStyle": "points",
                "pointSize": 5
              },
              "unit": "ms"
            }
          }
        },
        {
          "id": 11,
          "type": "table",
          "title": "Slowest Traces (p99)",
          "datasource": {"type": "tempo", "uid": "tempo"},
          "gridPos": {"h": 10, "w": 12, "x": 0, "y": 28},
          "targets": [
            {
              "queryType": "traceql",
              "query": "{ } | duration > 1s",
              "limit": 20,
              "refId": "A"
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "renameByName": {
                  "traceID": "Trace ID",
                  "rootServiceName": "Service",
                  "duration": "Duration",
                  "spanCount": "Spans"
                }
              }
            }
          ],
          "fieldConfig": {
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Trace ID"},
                "properties": [
                  {
                    "id": "links",
                    "value": [
                      {
                        "title": "View Trace",
                        "url": "/explore?left={\"datasource\":\"tempo\",\"queries\":[{\"query\":\"${__value.raw}\",\"queryType\":\"traceId\"}]}"
                      }
                    ]
                  }
                ]
              },
              {
                "matcher": {"id": "byName", "options": "Duration"},
                "properties": [
                  {
                    "id": "unit",
                    "value": "ms"
                  },
                  {
                    "id": "custom.cellOptions",
                    "value": {
                      "type": "color-background"
                    }
                  },
                  {
                    "id": "color",
                    "value": {
                      "mode": "thresholds"
                    }
                  },
                  {
                    "id": "thresholds",
                    "value": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null},
                        {"color": "yellow", "value": 500},
                        {"color": "red", "value": 1000}
                      ]
                    }
                  }
                ]
              }
            ]
          }
        },
        {
          "id": 12,
          "type": "table",
          "title": "Error Traces",
          "datasource": {"type": "tempo", "uid": "tempo"},
          "gridPos": {"h": 10, "w": 12, "x": 12, "y": 28},
          "targets": [
            {
              "queryType": "traceql",
              "query": "{ status = error }",
              "limit": 20,
              "refId": "A"
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "renameByName": {
                  "traceID": "Trace ID",
                  "rootServiceName": "Service",
                  "errorMessage": "Error",
                  "timestamp": "Time"
                }
              }
            }
          ],
          "fieldConfig": {
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Trace ID"},
                "properties": [
                  {
                    "id": "links",
                    "value": [
                      {
                        "title": "View Trace",
                        "url": "/explore?left={\"datasource\":\"tempo\",\"queries\":[{\"query\":\"${__value.raw}\",\"queryType\":\"traceId\"}]}"
                      },
                      {
                        "title": "View Logs",
                        "url": "/explore?left={\"datasource\":\"loki\",\"queries\":[{\"expr\":\"{namespace=\\\"orange-wallet\\\"} | json | trace_id=\\\"${__value.raw}\\\"\"}]}"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        }
      ]
    }

  # ===========================================================================
  # Dashboard 5: Infrastructure & Kubernetes Monitoring
  # ===========================================================================
  infrastructure-monitoring.json: |
    {
      "title": "Infrastructure & Kubernetes Monitoring",
      "uid": "infra-orange-wallet",
      "tags": ["infrastructure", "kubernetes", "nodes", "pods"],
      "timezone": "browser",
      "refresh": "30s",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "panels": [
        {
          "id": 1,
          "type": "row",
          "title": "Cluster Overview",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
          "collapsed": false
        },
        {
          "id": 2,
          "type": "stat",
          "title": "Total Nodes",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 0, "y": 1},
          "targets": [
            {
              "expr": "count(kube_node_info)",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "blue", "value": null}
                ]
              }
            }
          }
        },
        {
          "id": 3,
          "type": "stat",
          "title": "Ready Nodes",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 4, "y": 1},
          "targets": [
            {
              "expr": "sum(kube_node_status_condition{condition=\"Ready\", status=\"true\"})",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "red", "value": null},
                  {"color": "yellow", "value": 2},
                  {"color": "green", "value": 3}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background"
          }
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Total Pods",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 8, "y": 1},
          "targets": [
            {
              "expr": "count(kube_pod_info{namespace=\"orange-wallet\"})",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null}
                ]
              }
            }
          }
        },
        {
          "id": 5,
          "type": "stat",
          "title": "Running Pods",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 12, "y": 1},
          "targets": [
            {
              "expr": "sum(kube_pod_status_phase{namespace=\"orange-wallet\", phase=\"Running\"})",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background"
          }
        },
        {
          "id": 6,
          "type": "stat",
          "title": "Failed Pods",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 16, "y": 1},
          "targets": [
            {
              "expr": "sum(kube_pod_status_phase{namespace=\"orange-wallet\", phase=\"Failed\"})",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "red", "value": 1}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background"
          }
        },
        {
          "id": 7,
          "type": "stat",
          "title": "Pod Restarts (1h)",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 4, "w": 4, "x": 20, "y": 1},
          "targets": [
            {
              "expr": "sum(increase(kube_pod_container_status_restarts_total{namespace=\"orange-wallet\"}[1h]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 5},
                  {"color": "red", "value": 10}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background"
          }
        },
        {
          "id": 10,
          "type": "row",
          "title": "Node Resources",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 5},
          "collapsed": false
        },
        {
          "id": 11,
          "type": "timeseries",
          "title": "Node CPU Usage",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 6},
          "targets": [
            {
              "expr": "(1 - avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) by (instance)) * 100",
              "legendFormat": "{{instance}}",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "drawStyle": "line",
                "lineWidth": 2,
                "fillOpacity": 10
              },
              "unit": "percent",
              "min": 0,
              "max": 100
            }
          }
        },
        {
          "id": 12,
          "type": "timeseries",
          "title": "Node Memory Usage",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 6},
          "targets": [
            {
              "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
              "legendFormat": "{{instance}}",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "drawStyle": "line",
                "lineWidth": 2,
                "fillOpacity": 10
              },
              "unit": "percent",
              "min": 0,
              "max": 100
            }
          }
        },
        {
          "id": 13,
          "type": "timeseries",
          "title": "Node Disk Usage",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14},
          "targets": [
            {
              "expr": "(1 - (node_filesystem_avail_bytes{mountpoint=\"/\"} / node_filesystem_size_bytes{mountpoint=\"/\"})) * 100",
              "legendFormat": "{{instance}}",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "drawStyle": "line",
                "lineWidth": 2,
                "fillOpacity": 10
              },
              "unit": "percent",
              "min": 0,
              "max": 100,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 70},
                  {"color": "red", "value": 85}
                ]
              }
            }
          }
        },
        {
          "id": 14,
          "type": "timeseries",
          "title": "Network I/O",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 14},
          "targets": [
            {
              "expr": "rate(node_network_receive_bytes_total{device!~\"lo|docker.*|veth.*\"}[5m])",
              "legendFormat": "{{instance}} RX",
              "refId": "A"
            },
            {
              "expr": "rate(node_network_transmit_bytes_total{device!~\"lo|docker.*|veth.*\"}[5m])",
              "legendFormat": "{{instance}} TX",
              "refId": "B"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "drawStyle": "line",
                "lineWidth": 2,
                "fillOpacity": 10
              },
              "unit": "Bps"
            }
          }
        },
        {
          "id": 20,
          "type": "row",
          "title": "Pod Resources",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 22},
          "collapsed": false
        },
        {
          "id": 21,
          "type": "table",
          "title": "Pod Resource Usage",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 12, "w": 24, "x": 0, "y": 23},
          "targets": [
            {
              "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"orange-wallet\", container!=\"\"}[5m])) by (pod)",
              "format": "table",
              "instant": true,
              "refId": "A"
            },
            {
              "expr": "sum(container_memory_working_set_bytes{namespace=\"orange-wallet\", container!=\"\"}) by (pod) / 1024 / 1024",
              "format": "table",
              "instant": true,
              "refId": "B"
            },
            {
              "expr": "sum(kube_pod_container_status_restarts_total{namespace=\"orange-wallet\"}) by (pod)",
              "format": "table",
              "instant": true,
              "refId": "C"
            }
          ],
          "transformations": [
            {
              "id": "merge"
            },
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true},
                "renameByName": {
                  "pod": "Pod",
                  "Value #A": "CPU (cores)",
                  "Value #B": "Memory (MB)",
                  "Value #C": "Restarts"
                }
              }
            }
          ],
          "options": {
            "showHeader": true,
            "sortBy": [
              {
                "displayName": "CPU (cores)",
                "desc": true
              }
            ]
          },
          "fieldConfig": {
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "CPU (cores)"},
                "properties": [
                  {
                    "id": "custom.cellOptions",
                    "value": {
                      "type": "color-background",
                      "mode": "gradient"
                    }
                  },
                  {
                    "id": "decimals",
                    "value": 3
                  }
                ]
              },
              {
                "matcher": {"id": "byName", "options": "Memory (MB)"},
                "properties": [
                  {
                    "id": "custom.cellOptions",
                    "value": {
                      "type": "color-background",
                      "mode": "gradient"
                    }
                  },
                  {
                    "id": "decimals",
                    "value": 0
                  }
                ]
              },
              {
                "matcher": {"id": "byName", "options": "Restarts"},
                "properties": [
                  {
                    "id": "custom.cellOptions",
                    "value": {
                      "type": "color-background"
                    }
                  },
                  {
                    "id": "color",
                    "value": {
                      "mode": "thresholds"
                    }
                  },
                  {
                    "id": "thresholds",
                    "value": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null},
                        {"color": "yellow", "value": 3},
                        {"color": "red", "value": 10}
                      ]
                    }
                  }
                ]
              }
            ]
          }
        },
        {
          "id": 30,
          "type": "row",
          "title": "Persistent Volume Claims",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 35},
          "collapsed": false
        },
        {
          "id": 31,
          "type": "table",
          "title": "PVC Usage",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 36},
          "targets": [
            {
              "expr": "(kubelet_volume_stats_used_bytes{namespace=\"orange-wallet\"} / kubelet_volume_stats_capacity_bytes{namespace=\"orange-wallet\"}) * 100",
              "format": "table",
              "instant": true,
              "refId": "A"
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "job": true, "instance": true},
                "renameByName": {
                  "persistentvolumeclaim": "PVC",
                  "Value": "Usage %"
                }
              }
            }
          ],
          "fieldConfig": {
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Usage %"},
                "properties": [
                  {
                    "id": "unit",
                    "value": "percent"
                  },
                  {
                    "id": "custom.cellOptions",
                    "value": {
                      "type": "gauge",
                      "mode": "gradient"
                    }
                  },
                  {
                    "id": "color",
                    "value": {
                      "mode": "thresholds"
                    }
                  },
                  {
                    "id": "thresholds",
                    "value": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null},
                        {"color": "yellow", "value": 70},
                        {"color": "red", "value": 85}
                      ]
                    }
                  }
                ]
              }
            ]
          }
        }
      ]
    }

  # ===========================================================================
  # Dashboard 6: Security & Audit Dashboard
  # ===========================================================================
  security-audit.json: |
    {
      "title": "Security & Audit Dashboard",
      "uid": "security-orange-wallet",
      "tags": ["security", "audit", "compliance"],
      "timezone": "browser",
      "refresh": "1m",
      "time": {
        "from": "now-24h",
        "to": "now"
      },
      "panels": [
        {
          "id": 1,
          "type": "row",
          "title": "Authentication & Authorization",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
          "collapsed": false
        },
        {
          "id": 2,
          "type": "stat",
          "title": "Failed Logins (24h)",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 6, "w": 6, "x": 0, "y": 1},
          "targets": [
            {
              "expr": "sum(increase(http_server_requests_seconds_count{namespace=\"orange-wallet\", uri=~\".*/auth/login.*\", status=\"401\"}[24h]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 50},
                  {"color": "red", "value": 200}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area"
          }
        },
        {
          "id": 3,
          "type": "stat",
          "title": "Unauthorized Access (24h)",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 6, "w": 6, "x": 6, "y": 1},
          "targets": [
            {
              "expr": "sum(increase(http_server_requests_seconds_count{namespace=\"orange-wallet\", status=\"403\"}[24h]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 20},
                  {"color": "red", "value": 100}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area"
          }
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Rate Limited Requests (1h)",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 6, "w": 6, "x": 12, "y": 1},
          "targets": [
            {
              "expr": "sum(increase(http_server_requests_seconds_count{namespace=\"orange-wallet\", status=\"429\"}[1h]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 100},
                  {"color": "red", "value": 500}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area"
          }
        },
        {
          "id": 5,
          "type": "stat",
          "title": "Invalid JWT Tokens (1h)",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 6, "w": 6, "x": 18, "y": 1},
          "targets": [
            {
              "expr": "sum(count_over_time({namespace=\"orange-wallet\"} | json | message=~\".*invalid.*token.*|.*jwt.*invalid.*\" [1h]))",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"color": "green", "value": null},
                  {"color": "yellow", "value": 10},
                  {"color": "red", "value": 50}
                ]
              }
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area"
          }
        },
        {
          "id": 10,
          "type": "timeseries",
          "title": "Failed Login Attempts Over Time",
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 7},
          "targets": [
            {
              "expr": "sum(rate(http_server_requests_seconds_count{namespace=\"orange-wallet\", uri=~\".*/auth/login.*\", status=\"401\"}[5m])) * 60",
              "legendFormat": "Failed Logins/min",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {
                "drawStyle": "line",
                "lineWidth": 2,
                "fillOpacity": 30
              },
              "unit": "short"
            }
          }
        },
        {
          "id": 11,
          "type": "logs",
          "title": "Recent Failed Login Attempts",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 7},
          "targets": [
            {
              "expr": "{namespace=\"orange-wallet\", application=\"authentication-service\"} | json | level=\"WARN\" | message=~\".*login.*failed.*|.*authentication.*failed.*\"",
              "refId": "A",
              "maxLines": 50
            }
          ],
          "options": {
            "showTime": true,
            "showLabels": false,
            "showCommonLabels": false,
            "wrapLogMessage": true,
            "sortOrder": "Descending"
          }
        },
        {
          "id": 20,
          "type": "row",
          "title": "IP Blocking & Rate Limiting",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 15},
          "collapsed": false
        },
        {
          "id": 21,
          "type": "table",
          "title": "Top IPs by Failed Login Attempts",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 10, "w": 12, "x": 0, "y": 16},
          "targets": [
            {
              "expr": "topk(20, sum(count_over_time({namespace=\"orange-wallet\", application=\"authentication-service\"} | json | level=\"WARN\" | message=~\".*login.*failed.*\" [24h])) by (client_ip))",
              "refId": "A",
              "instant": true
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true},
                "renameByName": {
                  "client_ip": "IP Address",
                  "Value": "Failed Attempts"
                }
              }
            }
          ],
          "options": {
            "showHeader": true,
            "sortBy": [
              {
                "displayName": "Failed Attempts",
                "desc": true
              }
            ]
          },
          "fieldConfig": {
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Failed Attempts"},
                "properties": [
                  {
                    "id": "custom.cellOptions",
                    "value": {
                      "type": "color-background",
                      "mode": "gradient"
                    }
                  },
                  {
                    "id": "color",
                    "value": {
                      "mode": "thresholds"
                    }
                  },
                  {
                    "id": "thresholds",
                    "value": {
                      "mode": "absolute",
                      "steps": [
                        {"color": "green", "value": null},
                        {"color": "yellow", "value": 10},
                        {"color": "red", "value": 50}
                      ]
                    }
                  }
                ]
              }
            ]
          }
        },
        {
          "id": 22,
          "type": "table",
          "title": "Currently Blocked IPs",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 10, "w": 12, "x": 12, "y": 16},
          "targets": [
            {
              "expr": "{namespace=\"orange-wallet\", application=\"api-gateway\"} | json | message=~\".*IP blocked.*|.*blocked IP.*\"",
              "refId": "A",
              "maxLines": 100
            }
          ],
          "transformations": [
            {
              "id": "extractFields",
              "options": {
                "source": "Line",
                "format": "json"
              }
            },
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Line": true},
                "renameByName": {
                  "timestamp": "Blocked At",
                  "client_ip": "IP Address",
                  "reason": "Reason",
                  "duration": "Duration"
                }
              }
            }
          ]
        },
        {
          "id": 30,
          "type": "row",
          "title": "Security Events Timeline",
          "gridPos": {"h": 1, "w": 24, "x": 0, "y": 26},
          "collapsed": false
        },
        {
          "id": 31,
          "type": "logs",
          "title": "All Security Events (Live Stream)",
          "datasource": {"type": "loki", "uid": "loki"},
          "gridPos": {"h": 12, "w": 24, "x": 0, "y": 27},
          "targets": [
            {
              "expr": "{namespace=\"orange-wallet\"} | json | message=~\".*security.*|.*auth.*|.*login.*|.*blocked.*|.*failed.*\" | level=~\"WARN|ERROR\"",
              "refId": "A"
            }
          ],
          "options": {
            "showTime": true,
            "showLabels": true,
            "showCommonLabels": false,
            "wrapLogMessage": true,
            "prettifyLogMessage": true,
            "enableLogDetails": true,
            "sortOrder": "Descending"
          }
        }
      ]
    }
